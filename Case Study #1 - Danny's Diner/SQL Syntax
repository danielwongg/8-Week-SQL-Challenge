```sql
SELECT sales.customer_id, SUM(price) AS total_sales
FROM sales
JOIN menu
ON sales.product_id=menu.product_id
GROUP BY customer_id
ORDER BY customer_id;
```


```sql
SELECT sales.customer_id, COUNT(DISTINCT(order_date)) AS times_visited
FROM sales
GROUP BY customer_id;
```


````sql
WITH order_ranked AS
(
	SELECT customer_id, order_date, product_name,
	DENSE_RANK() OVER(PARTITION BY sales.customer_id
	ORDER BY sales.order_date)
	AS ranking
	FROM sales
	JOIN menu
  	ON sales.product_id=menu.product_id
)

SELECT customer_id, product_name
FROM order_ranked
WHERE ranking = 1
GROUP BY customer_id, product_name;
````


````sql
SELECT product_name, COUNT(sales.product_id) AS times_ordered
FROM sales
JOIN menu
ON sales.product_id=menu.product_id
GROUP BY sales.product_id, product_name
ORDER BY COUNT(sales.product_id) DESC;
````


````sql
WITH most_ordered AS
(
    SELECT sales.customer_id, product_name, COUNT(sales.product_id) AS times_ordered,
    DENSE_RANK() OVER (PARTITION BY sales.customer_id
    ORDER BY COUNT(sales.product_id) DESC)
    AS ranking
    FROM sales
    JOIN menu
    ON sales.product_id=menu.product_id
    GROUP BY sales.customer_id, menu.product_name
)

SELECT customer_id, product_name, TimesOrdered
FROM most_ordered
WHERE ranking = 1;
````


````sql
WITH date_rank AS
(
    SELECT sales.customer_id, order_date, sales.product_id, join_date, product_name,
    ROW_NUMBER() OVER(PARTITION BY sales.customer_id
    ORDER BY order_date)
    AS ranking
    FROM sales
    JOIN members
    ON sales.customer_id=members.customer_id
    JOIN menu
    ON sales.product_id=menu.product_id
    WHERE order_date>=join_date
)

SELECT customer_id, product_name, order_date
FROM date_rank
WHERE ranking = 1
ORDER BY customer_id;
````


````sql
WITH date_rank AS
(
    SELECT sales.customer_id, order_date, join_date, product_name,
    DENSE_RANK() OVER(PARTITION BY sales.customer_id
    ORDER BY order_date DESC)
    AS ranking
    FROM sales
    JOIN members
    ON sales.customer_id=members.customer_id
    JOIN menu
    ON sales.product_id=menu.product_id
    WHERE order_date<join_date
)

SELECT customer_id, product_name, order_date, join_date
FROM date_rank
WHERE ranking = 1;
````


````sql
SELECT sales.customer_id, COUNT(product_name) AS total_items, SUM(price) AS total_spent
FROM sales
JOIN menu
ON menu.product_id=sales.product_id
JOIN members
ON members.customer_id=sales.customer_id
WHERE order_date<join_date
GROUP BY sales.customer_id
ORDER BY sales.customer_id;
````


````sql
SELECT sales.customer_id,
SUM(CASE
WHEN product_name = 'sushi' THEN price * 20
ELSE price * 10
END) AS points
FROM menu
JOIN sales
ON sales.product_id=menu.product_id
GROUP BY sales.customer_id;
````


````sql
SELECT sales.customer_id,
SUM(CASE
WHEN product_name = 'sushi' THEN price * 20
WHEN order_date BETWEEN join_date AND DATE_ADD(join_date, INTERVAL 7 DAY) THEN price * 20
ELSE price * 10
END) AS points
FROM menu
JOIN sales
ON sales.product_id=menu.product_id
JOIN members
ON sales.customer_id=members.customer_id
WHERE order_date<=LAST_DAY('2021-01-01')
GROUP BY sales.customer_id
ORDER BY sales.customer_id;
````


***


````sql
SELECT sales.customer_id, order_date, product_name, price,
CASE
WHEN order_date < join_date THEN 'N'
WHEN join_date IS NULL THEN 'N'
ELSE 'Y'
END AS member
FROM sales
LEFT JOIN members
ON sales.customer_id = members.customer_id
JOIN menu
ON sales.product_id = menu.product_id
ORDER BY sales.customer_id , order_date , product_name;
 ````


````sql
WITH ranks_cte AS
(
    SELECT sales.customer_id, order_date, product_name, price,
    CASE
    WHEN order_date < join_date THEN 'N'
    WHEN join_date IS NULL THEN 'N'
    ELSE 'Y'
    END AS member
    from sales
    LEFT JOIN members
    ON sales.customer_id = members.customer_id
    JOIN menu
    ON sales.product_id = menu.product_id
    ORDER BY sales.customer_id , order_date , product_name
)

SELECT *,
CASE
WHEN member = 'N' THEN NULL
ELSE
DENSE_RANK() OVER(PARTITION BY sales.customer_id, member
ORDER BY order_date)
END AS ranking
FROM ranks_cte;
````


***



